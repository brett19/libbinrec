/*
 * libbinrec: a recompiling translator for machine code
 * Copyright (c) 2016 Andrew Church <achurch@achurch.org>
 *
 * This software may be copied and redistributed under certain conditions;
 * see the file "COPYING" in the source code distribution for details.
 * NO WARRANTY is provided with this software.
 */

#include "tests/guest-ppc/insn/common.h"

static const uint8_t input[] = {
    0x10,0x22,0x18,0x2A,  // ps_add f1,f2,f3
};

static const unsigned int guest_opt = BINREC_OPT_G_PPC_IGNORE_FPSCR_VXFOO;
static const unsigned int common_opt = 0;

static const bool expected_success = true;

static const char expected[] =
    "[info] Scanning terminated at requested limit 0x3\n"
    "    0: LOAD_ARG   r1, 0\n"
    "    1: LOAD_ARG   r2, 1\n"
    "    2: GET_ALIAS  r3, a5\n"
    "    3: BFEXT      r4, r3, 12, 7\n"
    "    4: SET_ALIAS  a6, r4\n"
    "    5: GET_ALIAS  r5, a3\n"
    "    6: GET_ALIAS  r6, a4\n"
    "    7: FADD       r7, r5, r6\n"
    "    8: VFCVT      r8, r7\n"
    "    9: LOAD_IMM   r9, 0x1000000\n"
    "   10: VEXTRACT   r10, r8, 1\n"
    "   11: BITCAST    r11, r10\n"
    "   12: SLLI       r12, r11, 1\n"
    "   13: SEQ        r13, r12, r9\n"
    "   14: GOTO_IF_NZ r13, L1\n"
    "   15: VEXTRACT   r14, r8, 0\n"
    "   16: BITCAST    r15, r14\n"
    "   17: SLLI       r16, r15, 1\n"
    "   18: SEQ        r17, r16, r9\n"
    "   19: GOTO_IF_Z  r17, L2\n"
    "   20: LABEL      L1\n"
    "   21: FGETSTATE  r18\n"
    "   22: FSETROUND  r19, r18, TRUNC\n"
    "   23: FSETSTATE  r19\n"
    "   24: FADD       r20, r5, r6\n"
    "   25: VFCVT      r21, r20\n"
    "   26: FGETSTATE  r22\n"
    "   27: FCOPYROUND r23, r22, r18\n"
    "   28: FSETSTATE  r23\n"
    "   29: LABEL      L2\n"
    "   30: FGETSTATE  r24\n"
    "   31: FTESTEXC   r25, r24, INVALID\n"
    "   32: GOTO_IF_Z  r25, L3\n"
    "   33: GET_ALIAS  r26, a2\n"
    "   34: FCLEAREXC  r27, r24\n"
    "   35: FSETSTATE  r27\n"
    "   36: VEXTRACT   r28, r5, 0\n"
    "   37: VEXTRACT   r29, r6, 0\n"
    "   38: FADD       r30, r28, r29\n"
    "   39: FCVT       r31, r30\n"
    "   40: GET_ALIAS  r32, a5\n"
    "   41: FGETSTATE  r33\n"
    "   42: FCLEAREXC  r34, r33\n"
    "   43: FSETSTATE  r34\n"
    "   44: FTESTEXC   r35, r33, INVALID\n"
    "   45: GOTO_IF_Z  r35, L4\n"
    "   46: NOT        r36, r32\n"
    "   47: ORI        r37, r32, 16777216\n"
    "   48: ANDI       r38, r36, 16777216\n"
    "   49: SET_ALIAS  a5, r37\n"
    "   50: GOTO_IF_Z  r38, L5\n"
    "   51: ORI        r39, r37, -2147483648\n"
    "   52: SET_ALIAS  a5, r39\n"
    "   53: LABEL      L5\n"
    "   54: ANDI       r40, r32, 128\n"
    "   55: GOTO_IF_Z  r40, L4\n"
    "   56: GET_ALIAS  r41, a6\n"
    "   57: ANDI       r42, r41, 31\n"
    "   58: SET_ALIAS  a6, r42\n"
    "   59: GOTO       L6\n"
    "   60: LABEL      L4\n"
    "   61: FCVT       r43, r31\n"
    "   62: VBROADCAST r44, r43\n"
    "   63: SET_ALIAS  a2, r44\n"
    "   64: BITCAST    r45, r31\n"
    "   65: SGTUI      r46, r45, 0\n"
    "   66: SRLI       r47, r45, 31\n"
    "   67: BFEXT      r51, r45, 23, 8\n"
    "   68: SEQI       r48, r51, 0\n"
    "   69: SEQI       r49, r51, 255\n"
    "   70: SLLI       r52, r45, 9\n"
    "   71: SEQI       r50, r52, 0\n"
    "   72: AND        r53, r48, r50\n"
    "   73: XORI       r54, r50, 1\n"
    "   74: AND        r55, r49, r54\n"
    "   75: AND        r56, r48, r46\n"
    "   76: OR         r57, r56, r55\n"
    "   77: OR         r58, r53, r55\n"
    "   78: XORI       r59, r58, 1\n"
    "   79: XORI       r60, r47, 1\n"
    "   80: AND        r61, r47, r59\n"
    "   81: AND        r62, r60, r59\n"
    "   82: SLLI       r63, r57, 4\n"
    "   83: SLLI       r64, r61, 3\n"
    "   84: SLLI       r65, r62, 2\n"
    "   85: SLLI       r66, r53, 1\n"
    "   86: OR         r67, r63, r64\n"
    "   87: OR         r68, r65, r66\n"
    "   88: OR         r69, r67, r49\n"
    "   89: OR         r70, r69, r68\n"
    "   90: FTESTEXC   r71, r33, INEXACT\n"
    "   91: SLLI       r72, r71, 5\n"
    "   92: OR         r73, r70, r72\n"
    "   93: SET_ALIAS  a6, r73\n"
    "   94: GOTO_IF_Z  r71, L7\n"
    "   95: GET_ALIAS  r74, a5\n"
    "   96: NOT        r75, r74\n"
    "   97: ORI        r76, r74, 33554432\n"
    "   98: ANDI       r77, r75, 33554432\n"
    "   99: SET_ALIAS  a5, r76\n"
    "  100: GOTO_IF_Z  r77, L8\n"
    "  101: ORI        r78, r76, -2147483648\n"
    "  102: SET_ALIAS  a5, r78\n"
    "  103: LABEL      L8\n"
    "  104: LABEL      L7\n"
    "  105: FTESTEXC   r79, r33, OVERFLOW\n"
    "  106: GOTO_IF_Z  r79, L9\n"
    "  107: GET_ALIAS  r80, a5\n"
    "  108: NOT        r81, r80\n"
    "  109: ORI        r82, r80, 268435456\n"
    "  110: ANDI       r83, r81, 268435456\n"
    "  111: SET_ALIAS  a5, r82\n"
    "  112: GOTO_IF_Z  r83, L10\n"
    "  113: ORI        r84, r82, -2147483648\n"
    "  114: SET_ALIAS  a5, r84\n"
    "  115: LABEL      L10\n"
    "  116: LABEL      L9\n"
    "  117: FTESTEXC   r85, r33, UNDERFLOW\n"
    "  118: GOTO_IF_Z  r85, L6\n"
    "  119: GET_ALIAS  r86, a5\n"
    "  120: NOT        r87, r86\n"
    "  121: ORI        r88, r86, 134217728\n"
    "  122: ANDI       r89, r87, 134217728\n"
    "  123: SET_ALIAS  a5, r88\n"
    "  124: GOTO_IF_Z  r89, L11\n"
    "  125: ORI        r90, r88, -2147483648\n"
    "  126: SET_ALIAS  a5, r90\n"
    "  127: LABEL      L11\n"
    "  128: LABEL      L6\n"
    "  129: GET_ALIAS  r91, a2\n"
    "  130: VEXTRACT   r92, r91, 0\n"
    "  131: GET_ALIAS  r93, a6\n"
    "  132: VEXTRACT   r94, r5, 1\n"
    "  133: VEXTRACT   r95, r6, 1\n"
    "  134: FADD       r96, r94, r95\n"
    "  135: FCVT       r97, r96\n"
    "  136: GET_ALIAS  r98, a5\n"
    "  137: FGETSTATE  r99\n"
    "  138: FCLEAREXC  r100, r99\n"
    "  139: FSETSTATE  r100\n"
    "  140: FTESTEXC   r101, r99, INVALID\n"
    "  141: GOTO_IF_Z  r101, L12\n"
    "  142: NOT        r102, r98\n"
    "  143: ORI        r103, r98, 16777216\n"
    "  144: ANDI       r104, r102, 16777216\n"
    "  145: SET_ALIAS  a5, r103\n"
    "  146: GOTO_IF_Z  r104, L13\n"
    "  147: ORI        r105, r103, -2147483648\n"
    "  148: SET_ALIAS  a5, r105\n"
    "  149: LABEL      L13\n"
    "  150: ANDI       r106, r98, 128\n"
    "  151: GOTO_IF_Z  r106, L12\n"
    "  152: GET_ALIAS  r107, a6\n"
    "  153: ANDI       r108, r107, 31\n"
    "  154: SET_ALIAS  a6, r108\n"
    "  155: GOTO       L14\n"
    "  156: LABEL      L12\n"
    "  157: FCVT       r109, r97\n"
    "  158: VBROADCAST r110, r109\n"
    "  159: SET_ALIAS  a2, r110\n"
    "  160: BITCAST    r111, r97\n"
    "  161: SGTUI      r112, r111, 0\n"
    "  162: SRLI       r113, r111, 31\n"
    "  163: BFEXT      r117, r111, 23, 8\n"
    "  164: SEQI       r114, r117, 0\n"
    "  165: SEQI       r115, r117, 255\n"
    "  166: SLLI       r118, r111, 9\n"
    "  167: SEQI       r116, r118, 0\n"
    "  168: AND        r119, r114, r116\n"
    "  169: XORI       r120, r116, 1\n"
    "  170: AND        r121, r115, r120\n"
    "  171: AND        r122, r114, r112\n"
    "  172: OR         r123, r122, r121\n"
    "  173: OR         r124, r119, r121\n"
    "  174: XORI       r125, r124, 1\n"
    "  175: XORI       r126, r113, 1\n"
    "  176: AND        r127, r113, r125\n"
    "  177: AND        r128, r126, r125\n"
    "  178: SLLI       r129, r123, 4\n"
    "  179: SLLI       r130, r127, 3\n"
    "  180: SLLI       r131, r128, 2\n"
    "  181: SLLI       r132, r119, 1\n"
    "  182: OR         r133, r129, r130\n"
    "  183: OR         r134, r131, r132\n"
    "  184: OR         r135, r133, r115\n"
    "  185: OR         r136, r135, r134\n"
    "  186: FTESTEXC   r137, r99, INEXACT\n"
    "  187: SLLI       r138, r137, 5\n"
    "  188: OR         r139, r136, r138\n"
    "  189: SET_ALIAS  a6, r139\n"
    "  190: GOTO_IF_Z  r137, L15\n"
    "  191: GET_ALIAS  r140, a5\n"
    "  192: NOT        r141, r140\n"
    "  193: ORI        r142, r140, 33554432\n"
    "  194: ANDI       r143, r141, 33554432\n"
    "  195: SET_ALIAS  a5, r142\n"
    "  196: GOTO_IF_Z  r143, L16\n"
    "  197: ORI        r144, r142, -2147483648\n"
    "  198: SET_ALIAS  a5, r144\n"
    "  199: LABEL      L16\n"
    "  200: LABEL      L15\n"
    "  201: FTESTEXC   r145, r99, OVERFLOW\n"
    "  202: GOTO_IF_Z  r145, L17\n"
    "  203: GET_ALIAS  r146, a5\n"
    "  204: NOT        r147, r146\n"
    "  205: ORI        r148, r146, 268435456\n"
    "  206: ANDI       r149, r147, 268435456\n"
    "  207: SET_ALIAS  a5, r148\n"
    "  208: GOTO_IF_Z  r149, L18\n"
    "  209: ORI        r150, r148, -2147483648\n"
    "  210: SET_ALIAS  a5, r150\n"
    "  211: LABEL      L18\n"
    "  212: LABEL      L17\n"
    "  213: FTESTEXC   r151, r99, UNDERFLOW\n"
    "  214: GOTO_IF_Z  r151, L14\n"
    "  215: GET_ALIAS  r152, a5\n"
    "  216: NOT        r153, r152\n"
    "  217: ORI        r154, r152, 134217728\n"
    "  218: ANDI       r155, r153, 134217728\n"
    "  219: SET_ALIAS  a5, r154\n"
    "  220: GOTO_IF_Z  r155, L19\n"
    "  221: ORI        r156, r154, -2147483648\n"
    "  222: SET_ALIAS  a5, r156\n"
    "  223: LABEL      L19\n"
    "  224: LABEL      L14\n"
    "  225: GET_ALIAS  r157, a2\n"
    "  226: VEXTRACT   r158, r157, 0\n"
    "  227: GET_ALIAS  r159, a6\n"
    "  228: ANDI       r160, r159, 32\n"
    "  229: OR         r161, r93, r160\n"
    "  230: SET_ALIAS  a6, r161\n"
    "  231: GET_ALIAS  r162, a5\n"
    "  232: ANDI       r163, r162, 128\n"
    "  233: GOTO_IF_Z  r163, L20\n"
    "  234: SET_ALIAS  a2, r26\n"
    "  235: GOTO       L21\n"
    "  236: LABEL      L20\n"
    "  237: VBUILD2    r164, r92, r158\n"
    "  238: SET_ALIAS  a2, r164\n"
    "  239: GOTO       L21\n"
    "  240: LABEL      L3\n"
    "  241: GET_ALIAS  r165, a5\n"
    "  242: FGETSTATE  r166\n"
    "  243: FCLEAREXC  r167, r166\n"
    "  244: FSETSTATE  r167\n"
    "  245: FTESTEXC   r168, r166, INVALID\n"
    "  246: GOTO_IF_Z  r168, L22\n"
    "  247: NOT        r169, r165\n"
    "  248: ORI        r170, r165, 16777216\n"
    "  249: ANDI       r171, r169, 16777216\n"
    "  250: SET_ALIAS  a5, r170\n"
    "  251: GOTO_IF_Z  r171, L23\n"
    "  252: ORI        r172, r170, -2147483648\n"
    "  253: SET_ALIAS  a5, r172\n"
    "  254: LABEL      L23\n"
    "  255: ANDI       r173, r165, 128\n"
    "  256: GOTO_IF_Z  r173, L22\n"
    "  257: GET_ALIAS  r174, a6\n"
    "  258: ANDI       r175, r174, 31\n"
    "  259: SET_ALIAS  a6, r175\n"
    "  260: GOTO       L24\n"
    "  261: LABEL      L22\n"
    "  262: VFCVT      r176, r8\n"
    "  263: SET_ALIAS  a2, r176\n"
    "  264: VEXTRACT   r177, r8, 0\n"
    "  265: BITCAST    r178, r177\n"
    "  266: SGTUI      r179, r178, 0\n"
    "  267: SRLI       r180, r178, 31\n"
    "  268: BFEXT      r184, r178, 23, 8\n"
    "  269: SEQI       r181, r184, 0\n"
    "  270: SEQI       r182, r184, 255\n"
    "  271: SLLI       r185, r178, 9\n"
    "  272: SEQI       r183, r185, 0\n"
    "  273: AND        r186, r181, r183\n"
    "  274: XORI       r187, r183, 1\n"
    "  275: AND        r188, r182, r187\n"
    "  276: AND        r189, r181, r179\n"
    "  277: OR         r190, r189, r188\n"
    "  278: OR         r191, r186, r188\n"
    "  279: XORI       r192, r191, 1\n"
    "  280: XORI       r193, r180, 1\n"
    "  281: AND        r194, r180, r192\n"
    "  282: AND        r195, r193, r192\n"
    "  283: SLLI       r196, r190, 4\n"
    "  284: SLLI       r197, r194, 3\n"
    "  285: SLLI       r198, r195, 2\n"
    "  286: SLLI       r199, r186, 1\n"
    "  287: OR         r200, r196, r197\n"
    "  288: OR         r201, r198, r199\n"
    "  289: OR         r202, r200, r182\n"
    "  290: OR         r203, r202, r201\n"
    "  291: FTESTEXC   r204, r166, INEXACT\n"
    "  292: SLLI       r205, r204, 5\n"
    "  293: OR         r206, r203, r205\n"
    "  294: SET_ALIAS  a6, r206\n"
    "  295: GOTO_IF_Z  r204, L25\n"
    "  296: GET_ALIAS  r207, a5\n"
    "  297: NOT        r208, r207\n"
    "  298: ORI        r209, r207, 33554432\n"
    "  299: ANDI       r210, r208, 33554432\n"
    "  300: SET_ALIAS  a5, r209\n"
    "  301: GOTO_IF_Z  r210, L26\n"
    "  302: ORI        r211, r209, -2147483648\n"
    "  303: SET_ALIAS  a5, r211\n"
    "  304: LABEL      L26\n"
    "  305: LABEL      L25\n"
    "  306: FTESTEXC   r212, r166, OVERFLOW\n"
    "  307: GOTO_IF_Z  r212, L27\n"
    "  308: GET_ALIAS  r213, a5\n"
    "  309: NOT        r214, r213\n"
    "  310: ORI        r215, r213, 268435456\n"
    "  311: ANDI       r216, r214, 268435456\n"
    "  312: SET_ALIAS  a5, r215\n"
    "  313: GOTO_IF_Z  r216, L28\n"
    "  314: ORI        r217, r215, -2147483648\n"
    "  315: SET_ALIAS  a5, r217\n"
    "  316: LABEL      L28\n"
    "  317: LABEL      L27\n"
    "  318: FTESTEXC   r218, r166, UNDERFLOW\n"
    "  319: GOTO_IF_Z  r218, L24\n"
    "  320: GET_ALIAS  r219, a5\n"
    "  321: NOT        r220, r219\n"
    "  322: ORI        r221, r219, 134217728\n"
    "  323: ANDI       r222, r220, 134217728\n"
    "  324: SET_ALIAS  a5, r221\n"
    "  325: GOTO_IF_Z  r222, L29\n"
    "  326: ORI        r223, r221, -2147483648\n"
    "  327: SET_ALIAS  a5, r223\n"
    "  328: LABEL      L29\n"
    "  329: LABEL      L24\n"
    "  330: LABEL      L21\n"
    "  331: LOAD_IMM   r224, 4\n"
    "  332: SET_ALIAS  a1, r224\n"
    "  333: GET_ALIAS  r225, a5\n"
    "  334: GET_ALIAS  r226, a6\n"
    "  335: ANDI       r227, r225, -1611134977\n"
    "  336: SLLI       r228, r226, 12\n"
    "  337: OR         r229, r227, r228\n"
    "  338: SET_ALIAS  a5, r229\n"
    "  339: RETURN\n"
    "\n"
    "Alias 1: int32 @ 956(r1)\n"
    "Alias 2: float64[2] @ 400(r1)\n"
    "Alias 3: float64[2] @ 416(r1)\n"
    "Alias 4: float64[2] @ 432(r1)\n"
    "Alias 5: int32 @ 944(r1)\n"
    "Alias 6: int32, no bound storage\n"
    "\n"
    "Block 0: <none> --> [0,14] --> 1,2\n"
    "Block 1: 0 --> [15,19] --> 2,3\n"
    "Block 2: 1,0 --> [20,28] --> 3\n"
    "Block 3: 2,1 --> [29,32] --> 4,41\n"
    "Block 4: 3 --> [33,45] --> 5,9\n"
    "Block 5: 4 --> [46,50] --> 6,7\n"
    "Block 6: 5 --> [51,52] --> 7\n"
    "Block 7: 6,5 --> [53,55] --> 8,9\n"
    "Block 8: 7 --> [56,59] --> 21\n"
    "Block 9: 4,7 --> [60,94] --> 10,13\n"
    "Block 10: 9 --> [95,100] --> 11,12\n"
    "Block 11: 10 --> [101,102] --> 12\n"
    "Block 12: 11,10 --> [103,103] --> 13\n"
    "Block 13: 12,9 --> [104,106] --> 14,17\n"
    "Block 14: 13 --> [107,112] --> 15,16\n"
    "Block 15: 14 --> [113,114] --> 16\n"
    "Block 16: 15,14 --> [115,115] --> 17\n"
    "Block 17: 16,13 --> [116,118] --> 18,21\n"
    "Block 18: 17 --> [119,124] --> 19,20\n"
    "Block 19: 18 --> [125,126] --> 20\n"
    "Block 20: 19,18 --> [127,127] --> 21\n"
    "Block 21: 20,8,17 --> [128,141] --> 22,26\n"
    "Block 22: 21 --> [142,146] --> 23,24\n"
    "Block 23: 22 --> [147,148] --> 24\n"
    "Block 24: 23,22 --> [149,151] --> 25,26\n"
    "Block 25: 24 --> [152,155] --> 38\n"
    "Block 26: 21,24 --> [156,190] --> 27,30\n"
    "Block 27: 26 --> [191,196] --> 28,29\n"
    "Block 28: 27 --> [197,198] --> 29\n"
    "Block 29: 28,27 --> [199,199] --> 30\n"
    "Block 30: 29,26 --> [200,202] --> 31,34\n"
    "Block 31: 30 --> [203,208] --> 32,33\n"
    "Block 32: 31 --> [209,210] --> 33\n"
    "Block 33: 32,31 --> [211,211] --> 34\n"
    "Block 34: 33,30 --> [212,214] --> 35,38\n"
    "Block 35: 34 --> [215,220] --> 36,37\n"
    "Block 36: 35 --> [221,222] --> 37\n"
    "Block 37: 36,35 --> [223,223] --> 38\n"
    "Block 38: 37,25,34 --> [224,233] --> 39,40\n"
    "Block 39: 38 --> [234,235] --> 59\n"
    "Block 40: 38 --> [236,239] --> 59\n"
    "Block 41: 3 --> [240,246] --> 42,46\n"
    "Block 42: 41 --> [247,251] --> 43,44\n"
    "Block 43: 42 --> [252,253] --> 44\n"
    "Block 44: 43,42 --> [254,256] --> 45,46\n"
    "Block 45: 44 --> [257,260] --> 58\n"
    "Block 46: 41,44 --> [261,295] --> 47,50\n"
    "Block 47: 46 --> [296,301] --> 48,49\n"
    "Block 48: 47 --> [302,303] --> 49\n"
    "Block 49: 48,47 --> [304,304] --> 50\n"
    "Block 50: 49,46 --> [305,307] --> 51,54\n"
    "Block 51: 50 --> [308,313] --> 52,53\n"
    "Block 52: 51 --> [314,315] --> 53\n"
    "Block 53: 52,51 --> [316,316] --> 54\n"
    "Block 54: 53,50 --> [317,319] --> 55,58\n"
    "Block 55: 54 --> [320,325] --> 56,57\n"
    "Block 56: 55 --> [326,327] --> 57\n"
    "Block 57: 56,55 --> [328,328] --> 58\n"
    "Block 58: 57,45,54 --> [329,329] --> 59\n"
    "Block 59: 58,39,40 --> [330,339] --> <none>\n"
    ;

#include "tests/rtl-disasm-test.i"
