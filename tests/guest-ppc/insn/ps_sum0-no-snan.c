/*
 * libbinrec: a recompiling translator for machine code
 * Copyright (c) 2016 Andrew Church <achurch@achurch.org>
 *
 * This software may be copied and redistributed under certain conditions;
 * see the file "COPYING" in the source code distribution for details.
 * NO WARRANTY is provided with this software.
 */

#include "tests/guest-ppc/insn/common.h"

static const uint8_t input[] = {
    0x10,0x22,0x19,0x14,  // ps_sum0 f1,f2,f4,f3
};

static const unsigned int guest_opt = BINREC_OPT_G_PPC_ASSUME_NO_SNAN;
static const unsigned int common_opt = 0;

static const bool expected_success = true;

static const char expected[] =
    "[info] Scanning terminated at requested limit 0x3\n"
    "    0: LOAD_ARG   r1, 0\n"
    "    1: LOAD_ARG   r2, 1\n"
    "    2: GET_ALIAS  r3, a3\n"
    "    3: VEXTRACT   r4, r3, 0\n"
    "    4: GET_ALIAS  r5, a4\n"
    "    5: VEXTRACT   r6, r5, 1\n"
    "    6: GET_ALIAS  r7, a5\n"
    "    7: VEXTRACT   r8, r7, 1\n"
    "    8: FCVT       r9, r8\n"
    "    9: FADD       r10, r4, r6\n"
    "   10: FCVT       r11, r10\n"
    "   11: LOAD_IMM   r12, 0x1000000\n"
    "   12: BITCAST    r13, r11\n"
    "   13: SLLI       r14, r13, 1\n"
    "   14: SEQ        r15, r14, r12\n"
    "   15: GOTO_IF_Z  r15, L1\n"
    "   16: FGETSTATE  r16\n"
    "   17: FSETROUND  r17, r16, TRUNC\n"
    "   18: FSETSTATE  r17\n"
    "   19: FADD       r18, r4, r6\n"
    "   20: FCVT       r19, r18\n"
    "   21: FGETSTATE  r20\n"
    "   22: FCOPYROUND r21, r20, r16\n"
    "   23: FSETSTATE  r21\n"
    "   24: LABEL      L1\n"
    "   25: FGETSTATE  r22\n"
    "   26: FTESTEXC   r23, r22, INVALID\n"
    "   27: GOTO_IF_Z  r23, L2\n"
    "   28: GET_ALIAS  r24, a6\n"
    "   29: FGETSTATE  r25\n"
    "   30: FCLEAREXC  r26, r25\n"
    "   31: FSETSTATE  r26\n"
    "   32: FTESTEXC   r27, r25, INVALID\n"
    "   33: GOTO_IF_Z  r27, L4\n"
    "   34: BITCAST    r28, r4\n"
    "   35: SLLI       r29, r28, 13\n"
    "   36: BFEXT      r30, r28, 51, 12\n"
    "   37: SEQI       r31, r30, 4094\n"
    "   38: GOTO_IF_Z  r31, L6\n"
    "   39: GOTO_IF_NZ r29, L5\n"
    "   40: LABEL      L6\n"
    "   41: BITCAST    r32, r6\n"
    "   42: SLLI       r33, r32, 13\n"
    "   43: BFEXT      r34, r32, 51, 12\n"
    "   44: SEQI       r35, r34, 4094\n"
    "   45: GOTO_IF_Z  r35, L7\n"
    "   46: GOTO_IF_NZ r33, L5\n"
    "   47: LABEL      L7\n"
    "   48: NOT        r36, r24\n"
    "   49: ORI        r37, r24, 8388608\n"
    "   50: ANDI       r38, r36, 8388608\n"
    "   51: SET_ALIAS  a6, r37\n"
    "   52: GOTO_IF_Z  r38, L8\n"
    "   53: ORI        r39, r37, -2147483648\n"
    "   54: SET_ALIAS  a6, r39\n"
    "   55: LABEL      L8\n"
    "   56: ANDI       r40, r24, 128\n"
    "   57: GOTO_IF_Z  r40, L9\n"
    "   58: GET_ALIAS  r41, a6\n"
    "   59: BFEXT      r42, r41, 12, 7\n"
    "   60: ANDI       r43, r42, 31\n"
    "   61: GET_ALIAS  r44, a6\n"
    "   62: BFINS      r45, r44, r43, 12, 7\n"
    "   63: SET_ALIAS  a6, r45\n"
    "   64: GOTO       L3\n"
    "   65: LABEL      L9\n"
    "   66: LOAD_IMM   r46, nan(0x400000)\n"
    "   67: FCVT       r47, r46\n"
    "   68: VBROADCAST r48, r47\n"
    "   69: SET_ALIAS  a2, r48\n"
    "   70: LOAD_IMM   r49, 17\n"
    "   71: GET_ALIAS  r50, a6\n"
    "   72: BFINS      r51, r50, r49, 12, 7\n"
    "   73: SET_ALIAS  a6, r51\n"
    "   74: GOTO       L3\n"
    "   75: LABEL      L5\n"
    "   76: NOT        r52, r24\n"
    "   77: ORI        r53, r24, 16777216\n"
    "   78: ANDI       r54, r52, 16777216\n"
    "   79: SET_ALIAS  a6, r53\n"
    "   80: GOTO_IF_Z  r54, L10\n"
    "   81: ORI        r55, r53, -2147483648\n"
    "   82: SET_ALIAS  a6, r55\n"
    "   83: LABEL      L10\n"
    "   84: ANDI       r56, r24, 128\n"
    "   85: GOTO_IF_Z  r56, L4\n"
    "   86: GET_ALIAS  r57, a6\n"
    "   87: BFEXT      r58, r57, 12, 7\n"
    "   88: ANDI       r59, r58, 31\n"
    "   89: GET_ALIAS  r60, a6\n"
    "   90: BFINS      r61, r60, r59, 12, 7\n"
    "   91: SET_ALIAS  a6, r61\n"
    "   92: GOTO       L3\n"
    "   93: LABEL      L4\n"
    "   94: FCVT       r62, r11\n"
    "   95: VBROADCAST r63, r62\n"
    "   96: SET_ALIAS  a2, r63\n"
    "   97: BITCAST    r64, r11\n"
    "   98: SGTUI      r65, r64, 0\n"
    "   99: SRLI       r66, r64, 31\n"
    "  100: BFEXT      r70, r64, 23, 8\n"
    "  101: SEQI       r67, r70, 0\n"
    "  102: SEQI       r68, r70, 255\n"
    "  103: SLLI       r71, r64, 9\n"
    "  104: SEQI       r69, r71, 0\n"
    "  105: AND        r72, r67, r69\n"
    "  106: XORI       r73, r69, 1\n"
    "  107: AND        r74, r68, r73\n"
    "  108: AND        r75, r67, r65\n"
    "  109: OR         r76, r75, r74\n"
    "  110: OR         r77, r72, r74\n"
    "  111: XORI       r78, r77, 1\n"
    "  112: XORI       r79, r66, 1\n"
    "  113: AND        r80, r66, r78\n"
    "  114: AND        r81, r79, r78\n"
    "  115: SLLI       r82, r76, 4\n"
    "  116: SLLI       r83, r80, 3\n"
    "  117: SLLI       r84, r81, 2\n"
    "  118: SLLI       r85, r72, 1\n"
    "  119: OR         r86, r82, r83\n"
    "  120: OR         r87, r84, r85\n"
    "  121: OR         r88, r86, r68\n"
    "  122: OR         r89, r88, r87\n"
    "  123: FTESTEXC   r90, r25, INEXACT\n"
    "  124: SLLI       r91, r90, 5\n"
    "  125: OR         r92, r89, r91\n"
    "  126: GET_ALIAS  r93, a6\n"
    "  127: BFINS      r94, r93, r92, 12, 7\n"
    "  128: SET_ALIAS  a6, r94\n"
    "  129: GOTO_IF_Z  r90, L11\n"
    "  130: GET_ALIAS  r95, a6\n"
    "  131: NOT        r96, r95\n"
    "  132: ORI        r97, r95, 33554432\n"
    "  133: ANDI       r98, r96, 33554432\n"
    "  134: SET_ALIAS  a6, r97\n"
    "  135: GOTO_IF_Z  r98, L12\n"
    "  136: ORI        r99, r97, -2147483648\n"
    "  137: SET_ALIAS  a6, r99\n"
    "  138: LABEL      L12\n"
    "  139: LABEL      L11\n"
    "  140: FTESTEXC   r100, r25, OVERFLOW\n"
    "  141: GOTO_IF_Z  r100, L13\n"
    "  142: GET_ALIAS  r101, a6\n"
    "  143: NOT        r102, r101\n"
    "  144: ORI        r103, r101, 268435456\n"
    "  145: ANDI       r104, r102, 268435456\n"
    "  146: SET_ALIAS  a6, r103\n"
    "  147: GOTO_IF_Z  r104, L14\n"
    "  148: ORI        r105, r103, -2147483648\n"
    "  149: SET_ALIAS  a6, r105\n"
    "  150: LABEL      L14\n"
    "  151: LABEL      L13\n"
    "  152: FTESTEXC   r106, r25, UNDERFLOW\n"
    "  153: GOTO_IF_Z  r106, L3\n"
    "  154: GET_ALIAS  r107, a6\n"
    "  155: NOT        r108, r107\n"
    "  156: ORI        r109, r107, 134217728\n"
    "  157: ANDI       r110, r108, 134217728\n"
    "  158: SET_ALIAS  a6, r109\n"
    "  159: GOTO_IF_Z  r110, L15\n"
    "  160: ORI        r111, r109, -2147483648\n"
    "  161: SET_ALIAS  a6, r111\n"
    "  162: LABEL      L15\n"
    "  163: LABEL      L3\n"
    "  164: GET_ALIAS  r112, a6\n"
    "  165: ANDI       r113, r112, 128\n"
    "  166: GOTO_IF_NZ r113, L16\n"
    "  167: GET_ALIAS  r114, a2\n"
    "  168: VEXTRACT   r115, r114, 0\n"
    "  169: FCVT       r116, r9\n"
    "  170: VBUILD2    r117, r115, r116\n"
    "  171: SET_ALIAS  a2, r117\n"
    "  172: GOTO       L16\n"
    "  173: LABEL      L2\n"
    "  174: VBUILD2    r118, r11, r9\n"
    "  175: GET_ALIAS  r119, a6\n"
    "  176: FGETSTATE  r120\n"
    "  177: FCLEAREXC  r121, r120\n"
    "  178: FSETSTATE  r121\n"
    "  179: VFCVT      r122, r118\n"
    "  180: SET_ALIAS  a2, r122\n"
    "  181: VEXTRACT   r123, r118, 0\n"
    "  182: BITCAST    r124, r123\n"
    "  183: SGTUI      r125, r124, 0\n"
    "  184: SRLI       r126, r124, 31\n"
    "  185: BFEXT      r130, r124, 23, 8\n"
    "  186: SEQI       r127, r130, 0\n"
    "  187: SEQI       r128, r130, 255\n"
    "  188: SLLI       r131, r124, 9\n"
    "  189: SEQI       r129, r131, 0\n"
    "  190: AND        r132, r127, r129\n"
    "  191: XORI       r133, r129, 1\n"
    "  192: AND        r134, r128, r133\n"
    "  193: AND        r135, r127, r125\n"
    "  194: OR         r136, r135, r134\n"
    "  195: OR         r137, r132, r134\n"
    "  196: XORI       r138, r137, 1\n"
    "  197: XORI       r139, r126, 1\n"
    "  198: AND        r140, r126, r138\n"
    "  199: AND        r141, r139, r138\n"
    "  200: SLLI       r142, r136, 4\n"
    "  201: SLLI       r143, r140, 3\n"
    "  202: SLLI       r144, r141, 2\n"
    "  203: SLLI       r145, r132, 1\n"
    "  204: OR         r146, r142, r143\n"
    "  205: OR         r147, r144, r145\n"
    "  206: OR         r148, r146, r128\n"
    "  207: OR         r149, r148, r147\n"
    "  208: FTESTEXC   r150, r120, INEXACT\n"
    "  209: SLLI       r151, r150, 5\n"
    "  210: OR         r152, r149, r151\n"
    "  211: GET_ALIAS  r153, a6\n"
    "  212: BFINS      r154, r153, r152, 12, 7\n"
    "  213: SET_ALIAS  a6, r154\n"
    "  214: GOTO_IF_Z  r150, L18\n"
    "  215: GET_ALIAS  r155, a6\n"
    "  216: NOT        r156, r155\n"
    "  217: ORI        r157, r155, 33554432\n"
    "  218: ANDI       r158, r156, 33554432\n"
    "  219: SET_ALIAS  a6, r157\n"
    "  220: GOTO_IF_Z  r158, L19\n"
    "  221: ORI        r159, r157, -2147483648\n"
    "  222: SET_ALIAS  a6, r159\n"
    "  223: LABEL      L19\n"
    "  224: LABEL      L18\n"
    "  225: FTESTEXC   r160, r120, OVERFLOW\n"
    "  226: GOTO_IF_Z  r160, L20\n"
    "  227: GET_ALIAS  r161, a6\n"
    "  228: NOT        r162, r161\n"
    "  229: ORI        r163, r161, 268435456\n"
    "  230: ANDI       r164, r162, 268435456\n"
    "  231: SET_ALIAS  a6, r163\n"
    "  232: GOTO_IF_Z  r164, L21\n"
    "  233: ORI        r165, r163, -2147483648\n"
    "  234: SET_ALIAS  a6, r165\n"
    "  235: LABEL      L21\n"
    "  236: LABEL      L20\n"
    "  237: FTESTEXC   r166, r120, UNDERFLOW\n"
    "  238: GOTO_IF_Z  r166, L17\n"
    "  239: GET_ALIAS  r167, a6\n"
    "  240: NOT        r168, r167\n"
    "  241: ORI        r169, r167, 134217728\n"
    "  242: ANDI       r170, r168, 134217728\n"
    "  243: SET_ALIAS  a6, r169\n"
    "  244: GOTO_IF_Z  r170, L22\n"
    "  245: ORI        r171, r169, -2147483648\n"
    "  246: SET_ALIAS  a6, r171\n"
    "  247: LABEL      L22\n"
    "  248: LABEL      L17\n"
    "  249: LABEL      L16\n"
    "  250: LOAD_IMM   r172, 4\n"
    "  251: SET_ALIAS  a1, r172\n"
    "  252: RETURN\n"
    "\n"
    "Alias 1: int32 @ 956(r1)\n"
    "Alias 2: float64[2] @ 400(r1)\n"
    "Alias 3: float64[2] @ 416(r1)\n"
    "Alias 4: float64[2] @ 432(r1)\n"
    "Alias 5: float64[2] @ 448(r1)\n"
    "Alias 6: int32 @ 944(r1)\n"
    "\n"
    "Block 0: <none> --> [0,15] --> 1,2\n"
    "Block 1: 0 --> [16,23] --> 2\n"
    "Block 2: 1,0 --> [24,27] --> 3,31\n"
    "Block 3: 2 --> [28,33] --> 4,17\n"
    "Block 4: 3 --> [34,38] --> 5,6\n"
    "Block 5: 4 --> [39,39] --> 6,13\n"
    "Block 6: 5,4 --> [40,45] --> 7,8\n"
    "Block 7: 6 --> [46,46] --> 8,13\n"
    "Block 8: 7,6 --> [47,52] --> 9,10\n"
    "Block 9: 8 --> [53,54] --> 10\n"
    "Block 10: 9,8 --> [55,57] --> 11,12\n"
    "Block 11: 10 --> [58,64] --> 29\n"
    "Block 12: 10 --> [65,74] --> 29\n"
    "Block 13: 5,7 --> [75,80] --> 14,15\n"
    "Block 14: 13 --> [81,82] --> 15\n"
    "Block 15: 14,13 --> [83,85] --> 16,17\n"
    "Block 16: 15 --> [86,92] --> 29\n"
    "Block 17: 3,15 --> [93,129] --> 18,21\n"
    "Block 18: 17 --> [130,135] --> 19,20\n"
    "Block 19: 18 --> [136,137] --> 20\n"
    "Block 20: 19,18 --> [138,138] --> 21\n"
    "Block 21: 20,17 --> [139,141] --> 22,25\n"
    "Block 22: 21 --> [142,147] --> 23,24\n"
    "Block 23: 22 --> [148,149] --> 24\n"
    "Block 24: 23,22 --> [150,150] --> 25\n"
    "Block 25: 24,21 --> [151,153] --> 26,29\n"
    "Block 26: 25 --> [154,159] --> 27,28\n"
    "Block 27: 26 --> [160,161] --> 28\n"
    "Block 28: 27,26 --> [162,162] --> 29\n"
    "Block 29: 28,11,12,16,25 --> [163,166] --> 30,44\n"
    "Block 30: 29 --> [167,172] --> 44\n"
    "Block 31: 2 --> [173,214] --> 32,35\n"
    "Block 32: 31 --> [215,220] --> 33,34\n"
    "Block 33: 32 --> [221,222] --> 34\n"
    "Block 34: 33,32 --> [223,223] --> 35\n"
    "Block 35: 34,31 --> [224,226] --> 36,39\n"
    "Block 36: 35 --> [227,232] --> 37,38\n"
    "Block 37: 36 --> [233,234] --> 38\n"
    "Block 38: 37,36 --> [235,235] --> 39\n"
    "Block 39: 38,35 --> [236,238] --> 40,43\n"
    "Block 40: 39 --> [239,244] --> 41,42\n"
    "Block 41: 40 --> [245,246] --> 42\n"
    "Block 42: 41,40 --> [247,247] --> 43\n"
    "Block 43: 42,39 --> [248,248] --> 44\n"
    "Block 44: 43,29,30 --> [249,252] --> <none>\n"
    ;

#include "tests/rtl-disasm-test.i"
